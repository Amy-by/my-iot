**07新增：传感器模拟器配置表、场景清单及接口文档**

**一、需求规格说明书（新增模拟场景清单）**

**1. 核心模拟场景分类**

  -------------------- ------------------------------------- ------------------------------------------------------------------------
  场景类型             具体场景描述                          涉及参数/规则

  **正常数据模拟**     单设备定时上报正常数据                \- 烟雾浓度：0-smoke_threshold（默认100%）随机波动\<br\>-
                                                             温度：temp_lower_limit-temp_upper_limit（默认-10℃-50℃）随机波动\<br\>-
                                                             上报间隔：report_interval（默认30s）

  **批量设备模拟**     同时启动≤50个设备模拟，独立生成数据   \- 每个设备使用独立simulator_config配置\<br\>- 基于Netty
                                                             NIO模型实现并发，单设备故障不影响其他设备（复用故障隔离机制）

  **参数动态调整**     实时修改模拟参数并生效                \- 支持调整smoke_max/temp_min/report_interval等\<br\>-
                                                             调整后立即应用于下一次数据生成，无需重启模拟进程

  **报警场景模拟**     触发烟雾/温度/低电/防拆报警           \- 烟雾报警：随机生成\>烟雾阈值（概率alarm_probability）\<br\>-
                                                             温度报警：随机生成\>上限或\<下限（概率alarm_probability）\<br\>-
                                                             低电报警：电池电量\<20%（随机触发）\<br\>-
                                                             防拆报警：模拟触发Tag0x02信号（手动触发）

  **通信异常模拟**     模拟数据传输故障                      \- 帧校验失败：随机生成CRC错误（比例abnormal_rate）\<br\>-
                                                             数据重传：模拟未收到应答时，按30s间隔重传（最多3次）\<br\>-
                                                             离线状态：停止上报超过3倍normal_work_interval时长
  -------------------- ------------------------------------- ------------------------------------------------------------------------

**二、数据库表结构脚本（新增simulator_config表）**

  --------------------------------------------------------------
  SQL\
  \-- 模拟器配置表：存储传感器模拟参数\
  CREATE TABLE \`simulator_config\` (\
  \`id\` bigint NOT NULL AUTO_INCREMENT COMMENT \'主键\',\
  \`sensor_id\` varchar(32) NOT NULL COMMENT
  \'传感器IMEI（关联sensor_extend.sensor_id）\',\
  \`is_enabled\` tinyint NOT NULL DEFAULT 0 COMMENT
  \'模拟开关（1-启用，0-禁用）\',\
  \`smoke_min\` int NOT NULL DEFAULT 0 COMMENT
  \'烟雾浓度最小值（%）\',\
  \`smoke_max\` int NOT NULL DEFAULT 100 COMMENT
  \'烟雾浓度最大值（%）\',\
  \`temp_min\` tinyint NOT NULL DEFAULT -10 COMMENT
  \'温度最小值（℃）\',\
  \`temp_max\` tinyint NOT NULL DEFAULT 50 COMMENT
  \'温度最大值（℃）\',\
  \`alarm_probability\` decimal(5,2) NOT NULL DEFAULT 0.05
  COMMENT \'报警触发概率（0.00-1.00）\',\
  \`report_interval\` int NOT NULL DEFAULT 30 COMMENT
  \'数据上报间隔（秒）\',\
  \`abnormal_rate\` decimal(5,2) NOT NULL DEFAULT 0.10 COMMENT
  \'异常数据比例（0.00-1.00）\',\
  \`create_time\` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP
  COMMENT \'创建时间\',\
  \`update_time\` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON
  UPDATE CURRENT_TIMESTAMP COMMENT \'更新时间\',\
  PRIMARY KEY (\`id\`),\
  UNIQUE KEY \`idx_sensor_id\` (\`sensor_id\`),\
  CONSTRAINT \`fk_simulator_sensor\` FOREIGN KEY (\`sensor_id\`)
  REFERENCES \`sensor_extend\` (\`sensor_id\`) ON DELETE
  CASCADE\
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
  COMMENT=\'传感器模拟器配置表\';

  --------------------------------------------------------------

**三、接口文档（新增/simulator/\*接口）**

**1. 启动模拟**

**请求地址**：POST /api/simulator/start

**请求体**：

  -----------------------------------------------------------
  JSON\
  {\
  \"sensorIds\": \[\"869149040980562\",
  \"869149040980563\"\], // 可选，空则启动所有已配置设备\
  \"duration\": 3600 // 可选，模拟时长（秒），默认持续运行\
  }

  -----------------------------------------------------------

**响应**：

  -----------------------------------------------------------
  JSON\
  {\
  \"code\": 200,\
  \"msg\": \"模拟启动成功\",\
  \"data\": {\
  \"successCount\": 2,\
  \"failCount\": 0,\
  \"failReason\": \[\] //
  失败原因，如\"IMEI=xxx未配置模拟参数\"\
  }\
  }

  -----------------------------------------------------------

**2. 停止模拟**

**请求地址**：POST /api/simulator/stop

**请求体**：

  -----------------------------------------------------------
  JSON\
  {\
  \"sensorIds\": \[\"869149040980562\"\] //
  可选，空则停止所有运行中设备\
  }

  -----------------------------------------------------------

**响应**：

  -----------------------------------------------------------
  JSON\
  {\
  \"code\": 200,\
  \"msg\": \"模拟已停止\",\
  \"data\": {\
  \"stoppedIds\": \[\"869149040980562\"\]\
  }\
  }

  -----------------------------------------------------------

**3. 更新模拟参数**

**请求地址**：PUT /api/simulator/config

**请求体**：

  -----------------------------------------------------------
  JSON\
  {\
  \"sensorId\": \"869149040980562\",\
  \"config\": {\
  \"smokeMax\": 90,\
  \"alarmProbability\": 0.1,\
  \"reportInterval\": 60\
  }\
  }

  -----------------------------------------------------------

**响应**：

  -----------------------------------------------------------
  JSON\
  {\
  \"code\": 200,\
  \"msg\": \"参数更新成功\"\
  }

  -----------------------------------------------------------

**4. 查询模拟状态**

**请求地址**：GET
/api/simulator/status?sensorId=869149040980562（sensorId可选，空则查询所有）

**响应**：

  -----------------------------------------------------------
  JSON\
  {\
  \"code\": 200,\
  \"data\": {\
  \"sensorId\": \"869149040980562\",\
  \"isRunning\": true,\
  \"lastReportTime\": \"2024-05-20 10:30:00\",\
  \"generatedCount\": 150, // 累计生成数据条数\
  \"alarmCount\": 3, // 累计报警次数\
  \"abnormalCount\": 15 // 累计异常数据条数\
  }\
  }

  -----------------------------------------------------------
