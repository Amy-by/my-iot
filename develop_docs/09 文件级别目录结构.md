**09 文件级别目录结构**

**1. 目录结构（文件级，附简要功能关键词）**

```
my-iot/
├── src/main/java/com/ruoyi/iot/
│   ├── controller/
│   │   ├── SensorController.java              # 传感器上报/参数查询/配置下发
│   │   ├── DeviceBatchController.java         # 批量导入、批量联系人更新
│   │   ├── AlarmController.java               # 报警查询、确认/消音
│   │   ├── NotificationController.java        # 额度查询/调整、模板管理
│   │   └── LogController.java                 # 报警/通知/状态/配置日志查询导出
│   ├── service/
│   │   ├── sensor/
│   │   │   ├── SensorService.java             # 设备注册、状态维护、配置应用
│   │   │   └── impl/SensorServiceImpl.java    # SensorService实现
│   │   ├── alarm/
│   │   │   ├── SensorAlarmService.java        # 报警识别、优先级处理、下行控制
│   │   │   └── impl/SensorAlarmServiceImpl.java
│   │   └── notification/
│   │       ├── NotificationService.java       # 额度校验扣减、触发通知
│   │       ├── impl/NotificationServiceImpl.java
│   │       └── channel/
│   │           ├── SmsChannel.java            # 短信渠道适配
│   │           └── VoiceChannel.java          # 语音渠道适配
│   ├── netty/
│   │   ├── handler/Cat1FrameDecoder.java      # Cat1帧解码、CRC校验
│   │   ├── handler/Cat1BusinessHandler.java   # 按指令分发至业务
│   │   ├── server/Cat1NettyServer.java        # Netty启动、线程/端口配置
│   │   └── websocket/IotWebSocketService.java # 报警/状态实时推送
│   ├── protocol/v1/
│   │   ├── Cat1ProtocolAdapter.java           # Cat1 TLV解析→标准数据
│   │   └── tlv-dynamic-loader/TlvRuleLoader.java # TLV规则动态加载
│   ├── model/
│   │   ├── SensorDevice.java                  # 设备扩展实体
│   │   ├── SensorExtend.java                  # 设备扩展信息
│   │   ├── SensorContact.java                 # 传感器联系人
│   │   ├── NotificationQuota.java             # 通知额度
│   │   ├── AlarmLog.java                      # 报警日志
│   │   ├── NotificationLog.java               # 通知日志
│   │   ├── StatusLog.java                     # 状态变更日志
│   │   ├── ConfigLog.java                     # 配置操作日志
│   │   └── ImportLog.java                     # 批量导入日志
│   ├── mapper/
│   │   ├── SensorExtendMapper.java
│   │   ├── SensorContactMapper.java
│   │   ├── NotificationQuotaMapper.java
│   │   ├── AlarmLogMapper.java
│   │   ├── NotificationLogMapper.java
│   │   ├── StatusLogMapper.java
│   │   ├── ConfigLogMapper.java
│   │   └── ImportLogMapper.java
│   ├── config/iot/IotConfig.java              # IoT模块配置入口(Netty/Redis前缀/Prometheus)
│   ├── common/iot/IotConstants.java           # 指令码/Tag常量
│   ├── common/iot/IotException.java           # IoT专用异常
│   ├── util/frame-crypto/FrameCryptoUtil.java # 帧加解密工具
│   ├── util/code-gen/IotCodeGenUtil.java      # IoT代码生成工具
│   └── metrics/IotMetricsRegistrar.java       # 自定义指标注册
├── src/main/resources/iot/
│   ├── protocol/v1/frame-structure.json       # 帧字段定义
│   ├── protocol/v1/tlv-mapping.yaml           # TLV→物模型映射
│   ├── protocol/v1/encryption-config.yaml     # 加密参数
│   ├── simulator/default-params.yaml          # 模拟器默认参数
│   ├── simulator/scene-templates/*.yaml       # 场景脚本
│   ├── metrics/prometheus-rules.yml           # 指标规则
│   └── config/dependencies/version.properties # 依赖版本集中管理
├── src/main/resources/mapper/iot/
│   ├── SensorExtendMapper.xml
│   ├── SensorContactMapper.xml
│   ├── NotificationQuotaMapper.xml
│   ├── AlarmLogMapper.xml
│   ├── NotificationLogMapper.xml
│   ├── StatusLogMapper.xml
│   ├── ConfigLogMapper.xml
│   └── ImportLogMapper.xml
├── src/sql/iot/
│   ├── init/V1__init_iot_tables.sql           # 初始化建表/默认数据
│   └── upgrade/V1.1__add_sensor_fields.sql    # 版本升级示例
├── src/views/iot/
│   ├── SensorList.vue                         # 列表/筛选/批量操作入口
│   ├── SensorDetail.vue                       # 详情/实时状态/历史
│   ├── AlarmMonitor.vue                       # 实时报警弹窗
│   ├── QuotaManage.vue                        # 额度查询/调整
│   └── ImportWizard.vue                       # 批量导入流程
├── src/components/iot/
│   ├── form/SensorForm.vue                    # 传感器表单
│   ├── form/ContactForm.vue                   # 联系人表单
│   ├── chart/AlarmPie.vue                     # 报警类型饼图
│   └── docs/ComponentDocs.md                  # 组件使用说明
├── src/api/iot/
│   ├── sensor.ts                              # 设备/参数接口封装
│   ├── alarm.ts                               # 报警接口封装
│   ├── notification.ts                        # 额度/模板接口封装
│   └── import.ts                              # 导入接口封装
├── src/router/iot/index.ts                    # IoT路由注册
├── src/store/iot/modules/                     # Pinia 业务域状态
│   ├── sensor.ts
│   ├── alarm.ts
│   └── quota.ts
├── simulator/
│   ├── config/base.yaml                       # 独立模拟器配置
│   ├── scenes/default.yaml                    # 场景定义
│   └── script/start.sh                        # 独立运行入口
└── docs/
    ├── api/iot-http.md                        # HTTP & Netty 协议手册
    └── changelog/iot-changelog.md             # 版本更新记录
```

**2. 文件详解（功能/输入输出/数据结构/业务逻辑）**

- `controller/SensorController.java`
  - 功能：处理传感器上报、参数查询、配置下发。
  - 输入：
    - `POST /api/sensor/cat1/report {frameData}`
    - `GET /api/device/sensor/params?sensorId=...`
    - `POST /api/sensor/config {sensorId, configParams}`
  - 输出：上报应答帧号/注册状态、参数VO、配置确认状态。
  - 数据结构：`SensorReportDTO`、`SensorConfigCmd`、`SensorParamsVO`。
  - 逻辑：校验帧→协议适配→更新状态/参数→落库/缓存→返回应答。

- `controller/DeviceBatchController.java`
  - 功能：批量导入传感器、批量更新联系人。
  - 输入：
    - `POST /api/iot/device/batchImport` (multipart Excel)
    - `POST /api/device/sensor/batch/update-contacts {sensorIds, contacts[]}`
  - 输出：导入结果（成功/失败明细）、批量更新计数。
  - 数据结构：`BatchImportResultVO`、`BatchContactUpdateDTO`。
  - 逻辑：流式读取→唯一性校验→批量写表→记录`ImportLog`。

- `controller/AlarmController.java`
  - 功能：报警列表、确认/消音。
  - 输入：
    - `GET /api/alarm/list` 条件
    - `POST /api/alarm/ack {alarmId, action}`
  - 输出：分页报警日志、处理状态。
  - 数据结构：`AlarmQuery`、`AlarmAckCmd`、`AlarmLogVO`。
  - 逻辑：按条件查询`AlarmLog`→返回；确认/消音时调用下行控制或更新状态。

- `controller/NotificationController.java`
  - 功能：额度查询/调整、通知模板管理。
  - 输入：
    - `GET /api/notification/quota?sensorId=...`
    - `POST /api/notification/updateQuota {sensorId, freeVoiceCount?, freeSmsCount?, balance?}`
  - 输出：额度VO / 调整结果。
  - 数据结构：`QuotaVO`、`QuotaUpdateCmd`、`TemplateDTO`。
  - 逻辑：读缓存→不足回源DB→返回；调整时加锁更新DB+缓存。

- `controller/LogController.java`
  - 功能：报警/通知/状态/配置日志查询与导出。
  - 输入：
    - `GET /api/iot/logs` 条件（type, sensorId, timeRange）
    - `GET /api/iot/logs/export`
  - 输出：分页日志或Excel导出文件。
  - 数据结构：`LogQuery`、`AlarmLogVO`、`NotificationLogVO`、`StatusLogVO`、`ConfigLogVO`。
  - 逻辑：按类型路由到对应 mapper 查询；导出时限流、最多1000条。

- `service/sensor/SensorService(.java/.impl)`
  - 功能：注册、状态维护、配置应用、历史数据查询。
  - 输入：`SensorData`（协议适配产物）、`SensorConfigCmd`。
  - 输出：注册结果、状态更新结果、历史数据列表。
  - 数据结构：`SensorDevice`、`SensorExtend`、`SensorStatus`、`SensorConfig`。
  - 逻辑：解析IMEI→落`SensorExtend`/缓存→发布状态事件；配置下发生成帧，等待确认。

- `service/alarm/SensorAlarmService(.java/.impl)`
  - 功能：报警识别、优先级判断、日志入库、触发通知/推送。
  - 输入：`SensorData`（含TLV）；
  - 输出：`AlarmLog`记录、WebSocket消息、通知触发。
  - 数据结构：`AlarmType`、`AlarmLog`。
  - 逻辑：按Tag优先级解析（火灾>防拆>温度>低电）→写`AlarmLog`→推送→触发通知。

- `service/notification/NotificationService(.java/.impl)`
  - 功能：额度校验扣减、通知触发、渠道适配。
  - 输入：
    - `triggerNotification(sensorId, alarmType)`
    - `checkAndDeductQuota(sensorId, notifyType)`
  - 输出：通知发送结果、额度更新。
  - 数据结构：`NotificationQuota`、`SensorContact`、`NotificationRecord`。
  - 逻辑：Redis锁+Lua原子扣减→调用`SmsChannel`/`VoiceChannel`→写`NotificationLog`。

- `netty/handler/Cat1FrameDecoder.java`
  - 功能：帧解码、CRC校验、粘拆包处理。
  - 输入：字节流；输出：`SensorData`。
  - 逻辑：0x7E包头尾校验→长度/CRC→交给业务handler。

- `netty/handler/Cat1BusinessHandler.java`
  - 功能：按指令分发业务（注册/状态/参数/报警）。
  - 输入：`SensorData`；输出：业务调用结果。
  - 逻辑：识别指令码→调用`SensorService`/`SensorAlarmService`。

- `netty/server/Cat1NettyServer.java`
  - 功能：Netty启动、端口/线程配置、生命周期管理。
  - 输入：配置（端口、boss/worker线程）。
  - 输出：通道初始化完成事件。

- `netty/websocket/IotWebSocketService.java`
  - 功能：报警、状态变更实时推送前端。
  - 输入：业务事件（AlarmEvent/StatusEvent）。
  - 输出：WebSocket消息（JSON）。

- `protocol/v1/Cat1ProtocolAdapter.java`
  - 功能：TLV解析、物模型映射、标准化`SensorData`。
  - 输入：原始帧；输出：`SensorData`（包含TLV Map、指令码、IMEI）。
  - 逻辑：校验头尾→解析指令/时间/帧号→TLV映射→判断注册/参数/状态。

- `protocol/v1/tlv-dynamic-loader/TlvRuleLoader.java`
  - 功能：加载/刷新TLV映射规则（配置化）。
  - 输入：配置源；输出：`Map<Tag, FieldMeta>`。

- `model/*.java`
  - 功能：实体/VO/DTO；对应表：`sensor_extend`、`sensor_contact`、`notification_quota`、`sensor_alarm_log`、`notification_log`、`status_log`、`config_log`、`iot_import_log`。
  - 输入输出：ORM映射对象，服务/控制器之间的数据承载。

- `mapper/*.java` + `resources/mapper/iot/*.xml`
  - 功能：MyBatis接口与XML映射，提供表CRUD及分页查询/导出。

- `config/iot/IotConfig.java`
  - 功能：模块级配置装配（Netty、Redis键前缀、Prometheus自定义指标开关）。

- `common/iot/IotConstants.java`
  - 功能：指令码、Tag、缓存Key常量。

- `common/iot/IotException.java`
  - 功能：IoT专用业务异常，统一错误码。

- `util/frame-crypto/FrameCryptoUtil.java`
  - 功能：帧加解密（AES/DES），读取`encryption-config.yaml`。

- `util/code-gen/IotCodeGenUtil.java`
  - 功能：IoT表/协议模板的代码生成辅助。

- `metrics/IotMetricsRegistrar.java`
  - 功能：注册Netty连接数、消息吞吐、报警频率等指标。

- `resources/iot/protocol/v1/frame-structure.json`
  - 功能：定义帧字段顺序/长度/校验规则。

- `resources/iot/protocol/v1/tlv-mapping.yaml`
  - 功能：TLV Tag 与物模型属性映射。

- `resources/iot/protocol/v1/encryption-config.yaml`
  - 功能：加密算法参数（密钥/模式/填充）。

- `resources/iot/simulator/*`
  - 功能：模拟器默认值、场景模板。

- `resources/iot/metrics/prometheus-rules.yml`
  - 功能：报警/吞吐等指标规则。

- `resources/iot/config/dependencies/version.properties`
  - 功能：依赖版本集中管理。

- `sql/init/…` 与 `sql/upgrade/…`
  - 功能：建表/初始化/增量升级脚本。

- 前端 `views/iot/*.vue`
  - 功能：列表、详情、报警监控、额度管理、导入流程。
  - 输入：API 查询条件/表单；输出：页面展示、用户操作事件。
  - 逻辑：调用 `api/iot` → 更新 `store` → 渲染/弹窗。

- 前端 `components/iot/*`
  - 功能：表单、图表、文档组件复用；输入为 props/数据集，输出为表单提交/图表展示。

- 前端 `api/iot/*.ts`
  - 功能：HTTP 封装，对应后端接口。

- 前端 `router/iot/index.ts`
  - 功能：路由注册（懒加载）。

- 前端 `store/iot/modules/*`
  - 功能：业务域状态（设备、报警、额度）。

- `simulator/*`
  - 功能：独立模拟器入口与场景脚本，调用核心 `iot/simulator` 逻辑。

- 文档 `docs/api/iot-http.md`
  - 功能：接口与协议手册；输入Swagger导出/手写，输出对接文档。

- 文档 `docs/changelog/iot-changelog.md`
  - 功能：记录版本变更。

**3. 第一次更新说明**
- 新增《09 文件级别目录结构》文档，按文件粒度列出后端/前端/资源/SQL/模拟器/文档的主要文件及职责。
- 为每个文件补充功能、输入输出、数据结构和业务逻辑要点，确保需求分析中的设备管理、报警处理、通知管理、日志、并发接入、额度控制、前端交互都有明确落点。
- 补充日志查询导出入口（LogController）与 WebSocket 推送服务（IotWebSocketService）的文件位置，呼应需求中的报警高亮与历史日志筛选。

**落地检查与风险备注（供后续核对）**
- 前端目录已对齐实际结构：`src/views`, `src/api`, `src/router`, `src/store`, `src/components`。
- 后端技术栈与设计一致（Spring Boot + MyBatis + Netty），但本地尚未搭建环境，需确认现有后端模块包名/入口是否与 `com.ruoyi.iot` 规划一致。
- 数据库表尚未创建，需按设计文档与 `src/sql/iot/init`/`upgrade` 脚本落库，或通过 Flyway/手工执行，确保与实体/Mapper 一致。
- WebSocket/Netty 与 HTTP 同/异端口方案未定，需明确部署与鉴权策略（跨域、认证、压测基线）。
- 日志导出（LogController）未确定脱敏/限流要求，上线前需补充合规和性能控制。
- `version.properties` 依赖版本集中管理的读取方式未确认，需验证构建链（如 Maven/Gradle 插件或自定义读取）是否实际使用。
- 模拟器独立模块与 `iot/simulator` 依赖关系需确认，避免重复实现或类路径冲突。

